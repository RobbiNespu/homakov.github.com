<script>
function generate(har){
  var entries = JSON.parse(har).log.entries;
  var cookies;
  var default_headers = headers_to_hash(entries[0].request.headers,{});
  var cache = {};
  var out="function get_headers(){return "+JSON.stringify(default_headers, undefined, 2)+"}\n\n";
  for(var i = 0; i < entries.length;i++){
    var request = entries[i].request;

    var hdr = headers_to_hash(request.headers, default_headers)
    hdr = hdr.length ? to_json(hdr) : '';
    var body = (request.postData && request.postData.text) ? request.postData.text : '';

    var expect = entries[i].response.status;
    if(entries[i].response.redirectURL)
    expect += " "+entries[i].response.redirectURL;

    var str = "run(\"" + [
    	request.method,
    	request.url,
    	body,
    	hdr,
    	expect
    	].join('","') + "\");\n"

    
    var cache_key = request.method+" "+request.url;
    if(!cache[cache_key]){
      out+=str;
    }
    cache[cache_key] = true;
  }
  document.getElementById('out').innerHTML = out
}

function to_json(in){
  return JSON.stringify(in, undefined, 2);
}

function headers_to_hash(headers, default_headers){
  var back = {}
  for(var i = 0;i<headers.length;i++){
  	if(default_headers[headers[i].name] && default_headers[headers[i].name] == headers[i].value){
  	  continue;
  	}

    back[headers[i].name] = headers[i].value;
  }
  return back;
}

</script>

<textarea raws=40 cols=80 onchange="generate(this.value);"></textarea>
<pre id="out"></pre>



